#!/bin/sh

set -eo pipefail

ARCH=$(uname -m)

case "$TARGETARCH $ARCH" in
' '* | 'amd64 x86_64' | 'arm64 aarch64') # native
    ;;
'amd64 '*) # amd64
    export CARGO_BUILD_TARGET=x86_64-unknown-linux-gnu
    rustup target add $CARGO_BUILD_TARGET
    ;;
'arm64 '*) # arm64
    export CARGO_BUILD_TARGET=aarch64-unknown-linux-gnu
    rustup target add $CARGO_BUILD_TARGET
    ;;
*)
    echo >&2 "Target arch $TARGETARCH is not supported"
    exit 1
    ;;
esac

TOOLCHAIN=$(rustup show active-toolchain | cut -d' ' -f1)

CARGO_TARGET_DIR="${CARGO_WRAPPER_TARGET_DIR:-$CARGO_TARGET_DIR}"
if [[ -n "$CARGO_TARGET_DIR" ]]; then
    export CARGO_TARGET_DIR="$CARGO_TARGET_DIR/$TOOLCHAIN"
fi

SCCACHE_DIR="${CARGO_WRAPPER_SCCACHE_DIR:-$SCCACHE_DIR}"
if [[ -n "$SCCACHE_DIR" ]]; then
    export SCCACHE_DIR="$SCCACHE_DIR/$TOOLCHAIN"
fi

export AR=llvm-ar
export CC=clang
export CXX=clang++
export LD=clang
export LDFLAGS=-fuse-ld=lld

# amd64
export CPPFLAGS_x86_64_unknown_linux_gnu=--target=x86_64-unknown-linux-gnu
export PKG_CONFIG_PATH_x86_64_unknown_linux_gnu=/usr/lib/x86_64-linux-gnu/pkgconfig
export PKG_CONFIG_SYSROOT_DIR_x86_64_unknown_linux_gnu=/usr/lib/x86_64-linux-gnu

export BINDGEN_EXTRA_CLANG_ARGS_x86_64_unknown_linux_gnu='--sysroot=/usr/lib/x86_64-linux-gnu --target=x86_64-unknown-linux-gnu'
export CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER=/usr/bin/clang
export CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS='-L/usr/lib/x86_64-linux-gnu -Clink-arg=-B/usr/x86_64-linux-gnu/bin -Clink-arg=--target=x86_64-unknown-linux-gnu -Clink-arg=-fuse-ld=lld'
export PQ_LIB_DIR_X86_64_UNKNOWN_LINUX_GNU=/usr/lib/x86_64-linux-gnu

# arm64
export CPPFLAGS_aarch64_unknown_linux_gnu=--target=aarch64-unknown-linux-gnu
export PKG_CONFIG_PATH_aarch64_unknown_linux_gnu=/usr/lib/aarch64-linux-gnu/pkgconfig
export PKG_CONFIG_SYSROOT_DIR_aarch64_unknown_linux_gnu=/usr/lib/aarch64-linux-gnu

export BINDGEN_EXTRA_CLANG_ARGS_aarch64_unknown_linux_gnu='--sysroot=/usr/lib/aarch64-linux-gnu --target=aarch64-unknown-linux-gnu'
export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=/usr/bin/clang
export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUSTFLAGS='-L/usr/lib/aarch64-linux-gnu -Clink-arg=-B/usr/aarch64-linux-gnu/bin -Clink-arg=--target=aarch64-unknown-linux-gnu  -Clink-arg=-fuse-ld=lld'
export PQ_LIB_DIR_AARCH64_UNKNOWN_LINUX_GNU=/usr/lib/aarch64-linux-gnu
