#!/bin/bash

set -eo pipefail

case "$TARGETARCH $(uname -m)" in
"amd64 x86_64" | "arm64 aarch64")
    ARCH="$TARGETARCH"
    ;;
"amd64 "* | " aarch64")
    ARCH=amd64
    PACKAGES="g++-x86-64-linux-gnu libc6-dev-amd64-cross"
    ;;
"arm64 "* | " x86_64")
    ARCH=arm64
    PACKAGES="g++-aarch64-linux-gnu libc6-dev-arm64-cross"
    ;;
*)
    echo >&2 "Target arch $TARGETARCH on $(uname -m) is not supported"
    exit 1
    ;;
esac

dpkg --add-architecture "$ARCH"

apt-get update
apt-get upgrade -y
apt-get install -y --no-install-recommends \
    cmake \
    libbz2-dev:$ARCH \
    libc6-dev:$ARCH \
    libcurl4-openssl-dev:$ARCH \
    liblzma-dev:$ARCH \
    libncurses5-dev:$ARCH \
    libncursesw5-dev:$ARCH \
    libpq-dev:$ARCH \
    libsqlite3-dev:$ARCH \
    libssl-dev:$ARCH \
    zlib1g-dev:$ARCH \
    zstd \
    $PACKAGES
